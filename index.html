<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 sm:p-8 md:p-12">
    <!-- Main Application Container -->
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl space-y-8">
        <header class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Fitness Tracker</h1>
            <p class="text-gray-500 mt-2">Track your daily progress and journey.</p>
            <div class="mt-4 p-2 bg-gray-100 rounded-lg text-sm text-gray-600">
                User ID: <span id="userIdDisplay" class="font-mono text-xs break-all"></span>
            </div>
        </header>

        <!-- Current Date and Navigation -->
        <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl shadow-inner">
            <button id="prevDayBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <span id="currentDateDisplay" class="text-lg font-semibold text-gray-700"></span>
            <button id="nextDayBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Calorie Card -->
            <div class="bg-blue-50 p-6 rounded-2xl shadow-md flex flex-col items-center">
                <h3 class="text-lg font-bold text-blue-800">Calories</h3>
                <p id="caloriesDisplay" class="text-3xl font-extrabold text-blue-600 mt-2">0</p>
            </div>
            <!-- Water Card -->
            <div class="bg-sky-50 p-6 rounded-2xl shadow-md flex flex-col items-center">
                <h3 class="text-lg font-bold text-sky-800">Water (ml)</h3>
                <p id="waterDisplay" class="text-3xl font-extrabold text-sky-600 mt-2">0</p>
            </div>
            <!-- Macronutrients Card -->
            <div class="bg-emerald-50 p-6 rounded-2xl shadow-md col-span-1 sm:col-span-2 lg:col-span-1">
                <h3 class="text-lg font-bold text-emerald-800">Macros</h3>
                <div class="mt-2 text-center">
                    <p id="macrosDisplay" class="text-lg font-semibold text-emerald-600">P: 0g | C: 0g | F: 0g</p>
                </div>
            </div>
            <!-- Micronutrients Card -->
            <div class="bg-purple-50 p-6 rounded-2xl shadow-md col-span-1 sm:col-span-2 lg:col-span-1">
                <h3 class="text-lg font-bold text-purple-800">Micros</h3>
                <div class="mt-2 text-center">
                    <p id="microsDisplay" class="text-sm text-purple-600">No data entered</p>
                </div>
            </div>
        </div>

        <!-- Input Form Section -->
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner space-y-6">
            <h2 class="text-2xl font-bold text-gray-700 text-center">Log Your Intake</h2>
            <form id="trackerForm" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- Water Input -->
                <div class="space-y-2">
                    <label for="waterInput" class="block font-medium text-gray-700">Water (ml)</label>
                    <input type="number" id="waterInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors" placeholder="e.g., 250">
                </div>
                <!-- Calorie Input -->
                <div class="space-y-2">
                    <label for="calorieInput" class="block font-medium text-gray-700">Calories</label>
                    <input type="number" id="calorieInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="e.g., 500">
                </div>
                <!-- Macros Input -->
                <div class="sm:col-span-2 grid grid-cols-3 gap-4">
                    <div class="space-y-2">
                        <label for="proteinInput" class="block font-medium text-gray-700">Protein (g)</label>
                        <input type="number" id="proteinInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="e.g., 20">
                    </div>
                    <div class="space-y-2">
                        <label for="carbsInput" class="block font-medium text-gray-700">Carbs (g)</label>
                        <input type="number" id="carbsInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="e.g., 30">
                    </div>
                    <div class="space-y-2">
                        <label for="fatsInput" class="block font-medium text-gray-700">Fats (g)</label>
                        <input type="number" id="fatsInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors" placeholder="e.g., 10">
                    </div>
                </div>
                <!-- Micronutrients Input -->
                <div class="sm:col-span-2 space-y-2">
                    <label for="microsInput" class="block font-medium text-gray-700">Micronutrients (e.g. vitamins, minerals)</label>
                    <input type="text" id="microsInput" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors" placeholder="e.g., Vitamin C, Iron">
                </div>
                <button type="submit" class="sm:col-span-2 w-full mt-4 py-3 px-6 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    Log Data
                </button>
            </form>
        </div>

        <!-- History/Journey Section -->
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner space-y-4">
            <h2 class="text-2xl font-bold text-gray-700 text-center">Your Journey</h2>
            <div id="historyList" class="space-y-3">
                <!-- History items will be dynamically added here -->
            </div>
            <div id="noHistoryMessage" class="text-center text-gray-500 hidden">
                No history available. Start logging to see your progress!
            </div>
        </div>

        <!-- Message/Status Modal -->
        <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center space-y-4">
                <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
                <button id="closeModalBtn" class="py-2 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let currentDate = new Date();
        const HISTORY_LIMIT = 7; // Display the last 7 days

        // UI elements
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const caloriesDisplay = document.getElementById('caloriesDisplay');
        const waterDisplay = document.getElementById('waterDisplay');
        const macrosDisplay = document.getElementById('macrosDisplay');
        const microsDisplay = document.getElementById('microsDisplay');
        const trackerForm = document.getElementById('trackerForm');
        const waterInput = document.getElementById('waterInput');
        const calorieInput = document.getElementById('calorieInput');
        const proteinInput = document.getElementById('proteinInput');
        const carbsInput = document.getElementById('carbsInput');
        const fatsInput = document.getElementById('fatsInput');
        const microsInput = document.getElementById('microsInput');
        const historyList = document.getElementById('historyList');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Helper functions
        const formatDate = (date) => {
            return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        const showMessage = (message) => {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        };

        const hideMessage = () => {
            messageModal.classList.add('hidden');
        };

        closeModalBtn.addEventListener('click', hideMessage);

        // Firebase Initialization and Authentication
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Enable Firestore logs

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log('User signed in with UID:', userId);
                        attachListeners();
                    } else {
                        console.log('No user signed in. Attempting anonymous or custom token sign-in.');
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth error:", error);
                            showMessage("Authentication failed. Please check the console for details.");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to initialize the app. Check the console for details.");
            }
        };

        // Firestore Data Management
        const getDailyDocRef = (date) => {
            const dateStr = date.toISOString().split('T')[0];
            const collectionPath = `/artifacts/${appId}/users/${userId}/daily_records`;
            return doc(db, collectionPath, dateStr);
        };

        const saveDailyData = async (date, data) => {
            if (!userId) {
                console.error("User ID is not available. Cannot save data.");
                return;
            }
            const docRef = getDailyDocRef(date);
            try {
                await setDoc(docRef, { ...data, timestamp: serverTimestamp() }, { merge: true });
                console.log("Data successfully saved for", date.toISOString().split('T')[0]);
                showMessage("Data logged successfully!");
            } catch (error) {
                console.error("Error saving data:", error);
                showMessage("Failed to save data. Please try again.");
            }
        };

        const loadDailyData = (date) => {
            if (!userId) return;
            const docRef = getDailyDocRef(date);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateUI(data);
                } else {
                    updateUI({ water: 0, calories: 0, macros: { protein: 0, carbs: 0, fats: 0 }, micros: '' });
                }
            }, (error) => {
                console.error("Error getting document:", error);
                showMessage("Failed to load daily data.");
            });
        };

        const loadHistory = async () => {
            if (!userId) return;
            const collectionPath = `/artifacts/${appId}/users/${userId}/daily_records`;
            const q = query(collection(db, collectionPath), orderBy("timestamp", "desc"));

            onSnapshot(q, (querySnapshot) => {
                historyList.innerHTML = '';
                if (querySnapshot.empty) {
                    noHistoryMessage.classList.remove('hidden');
                } else {
                    noHistoryMessage.classList.add('hidden');
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const dateStr = doc.id;
                        const historyItem = document.createElement('div');
                        historyItem.className = 'p-4 bg-white rounded-xl shadow-md cursor-pointer hover:shadow-lg transition-shadow';
                        historyItem.innerHTML = `
                            <div class="text-sm text-gray-500">${formatDate(new Date(dateStr))}</div>
                            <div class="mt-2 text-md font-semibold text-gray-800">Calories: <span class="text-blue-600">${data.calories || 0}</span> | Water: <span class="text-sky-600">${data.water || 0}ml</span></div>
                            <div class="text-sm text-gray-600 mt-1">P: ${data.macros?.protein || 0}g | C: ${data.macros?.carbs || 0}g | F: ${data.macros?.fats || 0}g</div>
                            ${data.micros ? `<div class="text-xs text-gray-400 mt-1">${data.micros}</div>` : ''}
                        `;
                        historyList.appendChild(historyItem);
                        historyItem.addEventListener('click', () => {
                            currentDate = new Date(dateStr);
                            updateDateDisplay();
                            loadDailyData(currentDate);
                        });
                    });
                }
            }, (error) => {
                console.error("Error loading history:", error);
            });
        };

        // UI Update Functions
        const updateUI = (data) => {
            caloriesDisplay.textContent = data.calories || 0;
            waterDisplay.textContent = data.water || 0;
            macrosDisplay.textContent = `P: ${data.macros?.protein || 0}g | C: ${data.macros?.carbs || 0}g | F: ${data.macros?.fats || 0}g`;
            microsDisplay.textContent = data.micros || 'No data entered';
        };

        const updateDateDisplay = () => {
            currentDateDisplay.textContent = formatDate(currentDate);
        };

        // Event Listeners
        const attachListeners = () => {
            updateDateDisplay();
            loadDailyData(currentDate);
            loadHistory();

            prevDayBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() - 1);
                updateDateDisplay();
                loadDailyData(currentDate);
            });

            nextDayBtn.addEventListener('click', () => {
                currentDate.setDate(currentDate.getDate() + 1);
                updateDateDisplay();
                loadDailyData(currentDate);
            });

            trackerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const water = parseInt(waterInput.value) || 0;
                const calories = parseInt(calorieInput.value) || 0;
                const protein = parseInt(proteinInput.value) || 0;
                const carbs = parseInt(carbsInput.value) || 0;
                const fats = parseInt(fatsInput.value) || 0;
                const micros = microsInput.value || '';

                const data = {
                    water: water,
                    calories: calories,
                    macros: { protein, carbs, fats },
                    micros: micros
                };
                saveDailyData(currentDate, data);
                trackerForm.reset();
            });
        };

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
